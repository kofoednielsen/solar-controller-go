<button onClick="install()" id="butDirectory">Install</button>
<script>
  const INIT_SCRIPT = 'init=/bin/sh -- -c "mount -t proc proc /proc; mount -t sysfs sys /sys; mount /boot; mount / -o remount,rw; /bin/python3 /boot/init.py; exec /sbin/init'
  const writeFile = async (fileHandle, contents) => {
    const writable = await fileHandle.createWritable();
    await writable.write(contents);
    await writable.close();
  }
  const readFile = async (fileHandle) => {
    const file = await fileHandle.getFile();
    return await file.text();
  }
  const install = async () => {
    try {
      const dirHandle = await window.showDirectoryPicker({mode: "readwrite"});
      const cmdLine = await dirHandle.getFileHandle('cmdLine.txt');
      console.log(cmdLine)
      let cmdLineContent = (await readFile(cmdLine)).replace('\n','')
      if (cmdLineContent.includes("init=")) {
        cmdLineContent = cmdLineContent.replace(/init=.+/, INIT_SCRIPT)
      } else {
        cmdLineContent += ' ' + INIT_SCRIPT
      }
      console.log(cmdLineContent)
      await writeFile(cmdLine, cmdLineContent)
      console.log("DONE updating cmdLine.txt")

      const downloadFileToUsb = async (filename) => {
        let r = await fetch('/' + filename)
        let blob = await r.blob()
        const fileHandle = await dirHandle.getFileHandle(filename, {create: 'true'});
        await writeFile(fileHandle, blob)
        console.log(`DONE downloading ${filename}`)
      }
      await downloadFileToUsb('init.py')
      await downloadFileToUsb('solar-controller')
      await downloadFileToUsb('solar-controller.service')
      alert("DONE, eject SD card and boot the pi. Then go to dashboard at http://solar-assistant.local:8080")
    } catch (e) {
      alert("An error occured. Please make sure to select the BOOT partition of the solar-assistant SD card")
      throw e
    }
  }
</script>
